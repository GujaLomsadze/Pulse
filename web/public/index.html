<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependency Graph Visualizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            overflow: hidden;
        }

        #root {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(20, 20, 35, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
        }

        .stat-label {
            color: #888;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        #cy {
            flex: 1;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0a0a0a 100%);
        }

        .node-details {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            background: rgba(30, 30, 45, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .node-details.visible {
            transform: translateX(0);
        }

        .node-details h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .node-type-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metadata-key {
            color: #aaa;
            font-size: 0.9rem;
        }

        .metadata-value {
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .dependency-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .dependency-item {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dependency-item:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #fff;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 0.5rem;
        }

        .control-button {
            background: rgba(30, 30, 45, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .control-button:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #667eea;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar styling */
        .node-details::-webkit-scrollbar {
            width: 8px;
        }

        .node-details::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .node-details::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .node-details::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const GraphVisualizer = () => {
            const [graphData, setGraphData] = useState(null);
            const [selectedNode, setSelectedNode] = useState(null);
            const [loading, setLoading] = useState(true);
            const [stats, setStats] = useState({});
            const cyRef = useRef(null);
            const containerRef = useRef(null);

            // Fetch graph data from API
            useEffect(() => {
                fetchGraphData();
            }, []);

            const fetchGraphData = async () => {
                try {
                    const response = await fetch('http://localhost:8000/graph');
                    const data = await response.json();
                    setGraphData(data);
                    setStats(data.stats || {});
                    setLoading(false);
                } catch (error) {
                    console.error('Error fetching graph:', error);
                    setLoading(false);
                }
            };

            // Initialize Cytoscape
            useEffect(() => {
                if (!graphData || !containerRef.current) return;

                // Prepare elements for Cytoscape
                const elements = [
                    // Nodes
                    ...graphData.nodes.map(node => ({
                        data: {
                            id: node.id,
                            label: node.label || node.id,
                            type: node.type,
                            ...node.metadata
                        },
                        classes: node.type
                    })),
                    // Edges
                    ...graphData.edges.map(edge => ({
                        data: {
                            id: edge.id || `${edge.source}-${edge.target}`,
                            source: edge.source,
                            target: edge.target,
                            ...edge.metadata
                        }
                    }))
                ];

                // Define node colors by type
                const nodeColors = {
                    api: '#667eea',
                    service: '#764ba2',
                    database: '#f093fb',
                    cache: '#4facfe',
                    queue: '#43e97b',
                    kafka: '#38f9d7',
                    storage: '#fa709a',
                    loadbalancer: '#fee140'
                };

                // Cytoscape configuration
                const cy = cytoscape({
                    container: containerRef.current,
                    elements: elements,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': (ele) => nodeColors[ele.data('type')] || '#667eea',
                                'label': 'data(label)',
                                'text-valign': 'bottom',
                                'text-halign': 'center',
                                'font-size': '12px',
                                'color': '#ffffff',
                                'text-outline-color': '#0a0a0a',
                                'text-outline-width': '2px',
                                'width': '60px',
                                'height': '60px',
                                'border-width': '2px',
                                'border-color': '#0a0a0a',
                                'border-opacity': 0.5,
                                'overlay-padding': '6px',
                                'transition-property': 'background-color, width, height, border-width',
                                'transition-duration': '0.3s'
                            }
                        },
                        {
                            selector: 'node:hover',
                            style: {
                                'width': '70px',
                                'height': '70px',
                                'border-width': '3px',
                                'border-color': '#ffffff',
                                'border-opacity': 0.3,
                                'z-index': 999
                            }
                        },
                        {
                            selector: 'node.highlighted',
                            style: {
                                'width': '80px',
                                'height': '80px',
                                'border-width': '4px',
                                'border-color': '#ffffff',
                                'border-opacity': 0.8,
                                'box-shadow': '0 0 30px rgba(102, 126, 234, 0.8)',
                                'z-index': 1000
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': 'rgba(255, 255, 255, 0.2)',
                                'target-arrow-color': 'rgba(255, 255, 255, 0.4)',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                'arrow-scale': 1.2,
                                'transition-property': 'line-color, width',
                                'transition-duration': '0.3s'
                            }
                        },
                        {
                            selector: 'edge:hover',
                            style: {
                                'width': 3,
                                'line-color': 'rgba(102, 126, 234, 0.6)',
                                'target-arrow-color': 'rgba(102, 126, 234, 0.8)',
                                'z-index': 999
                            }
                        },
                        {
                            selector: 'edge.highlighted',
                            style: {
                                'width': 4,
                                'line-color': '#667eea',
                                'target-arrow-color': '#667eea',
                                'z-index': 1000
                            }
                        }
                    ],
                    layout: {
                        name: 'breadthfirst',
                        directed: true,
                        padding: 50,
                        spacingFactor: 1.5,
                        animate: true,
                        animationDuration: 500,
                        avoidOverlap: true,
                        nodeDimensionsIncludeLabels: true
                    },
                    minZoom: 0.1,
                    maxZoom: 3,
                    wheelSensitivity: 0.2
                });

                // Store cy instance
                cyRef.current = cy;

                // Node click handler
                cy.on('tap', 'node', async (evt) => {
                    const node = evt.target;
                    const nodeId = node.id();

                    // Highlight node
                    cy.elements().removeClass('highlighted');
                    node.addClass('highlighted');

                    // Highlight connected edges
                    node.connectedEdges().addClass('highlighted');

                    // Fetch detailed node info
                    try {
                        const response = await fetch(`http://localhost:8000/graph/node/${nodeId}`);
                        const nodeDetails = await response.json();
                        setSelectedNode(nodeDetails);
                    } catch (error) {
                        console.error('Error fetching node details:', error);
                        // Use basic data if API fails
                        setSelectedNode({
                            node: {
                                id: nodeId,
                                type: node.data('type'),
                                metadata: node.data()
                            },
                            dependencies: [],
                            dependents: [],
                            metrics: {}
                        });
                    }
                });

                // Edge click handler
                cy.on('tap', 'edge', (evt) => {
                    const edge = evt.target;
                    cy.elements().removeClass('highlighted');
                    edge.addClass('highlighted');
                    edge.source().addClass('highlighted');
                    edge.target().addClass('highlighted');
                });

                // Background click - clear selection
                cy.on('tap', (evt) => {
                    if (evt.target === cy) {
                        cy.elements().removeClass('highlighted');
                        setSelectedNode(null);
                    }
                });

                // Cleanup
                return () => {
                    if (cyRef.current) {
                        cyRef.current.destroy();
                    }
                };
            }, [graphData]);

            // Layout controls
            const runLayout = useCallback((layoutName) => {
                if (!cyRef.current) return;

                const layouts = {
                    hierarchical: {
                        name: 'breadthfirst',
                        directed: true,
                        padding: 50,
                        spacingFactor: 1.5
                    },
                    circular: {
                        name: 'circle',
                        padding: 50,
                        animate: true
                    },
                    force: {
                        name: 'cose',
                        padding: 50,
                        nodeOverlap: 20,
                        idealEdgeLength: 100,
                        edgeElasticity: 100,
                        nestingFactor: 5,
                        gravity: 80,
                        numIter: 1000,
                        initialTemp: 200,
                        coolingFactor: 0.95,
                        minTemp: 1.0
                    },
                    grid: {
                        name: 'grid',
                        padding: 50,
                        rows: Math.ceil(Math.sqrt(cyRef.current.nodes().length))
                    }
                };

                const layout = cyRef.current.layout({
                    ...layouts[layoutName],
                    animate: true,
                    animationDuration: 500
                });
                layout.run();
            }, []);

            const fitGraph = useCallback(() => {
                if (cyRef.current) {
                    cyRef.current.fit(null, 50);
                }
            }, []);

            const resetZoom = useCallback(() => {
                if (cyRef.current) {
                    cyRef.current.zoom(1);
                    cyRef.current.center();
                }
            }, []);

            const highlightNode = useCallback((nodeId) => {
                if (!cyRef.current) return;

                const node = cyRef.current.$(`#${nodeId}`);
                if (node.length) {
                    cyRef.current.elements().removeClass('highlighted');
                    node.addClass('highlighted');
                    node.connectedEdges().addClass('highlighted');
                    cyRef.current.animate({
                        center: { eles: node },
                        zoom: 1.5
                    }, {
                        duration: 500
                    });
                }
            }, []);

            if (loading) {
                return <div className="loading">Loading graph data</div>;
            }

            return (
                <>
                    <div className="header">
                        <h1>🔗 Dependency Graph Visualizer</h1>
                        <div className="stats">
                            <div className="stat">
                                <div className="stat-value">{stats.node_count || 0}</div>
                                <div className="stat-label">Nodes</div>
                            </div>
                            <div className="stat">
                                <div className="stat-value">{stats.edge_count || 0}</div>
                                <div className="stat-label">Edges</div>
                            </div>
                            <div className="stat">
                                <div className="stat-value">{stats.connected_components || 0}</div>
                                <div className="stat-label">Components</div>
                            </div>
                            <div className="stat">
                                <div className="stat-value">{stats.is_dag ? '✓' : '✗'}</div>
                                <div className="stat-label">Acyclic</div>
                            </div>
                        </div>
                    </div>

                    <div className="main-container">
                        <div id="cy" ref={containerRef}></div>

                        <div className={`node-details ${selectedNode ? 'visible' : ''}`}>
                            {selectedNode && (
                                <>
                                    <button className="close-button" onClick={() => setSelectedNode(null)}>×</button>
                                    <h2>
                                        {selectedNode.node.id}
                                        <span className="node-type-badge">{selectedNode.node.type}</span>
                                    </h2>

                                    {Object.keys(selectedNode.node.metadata || {}).length > 0 && (
                                        <div className="detail-section">
                                            <h3>Metadata</h3>
                                            {Object.entries(selectedNode.node.metadata).map(([key, value]) => (
                                                <div key={key} className="metadata-item">
                                                    <span className="metadata-key">{key.replace(/_/g, ' ')}</span>
                                                    <span className="metadata-value">
                                                        {typeof value === 'object' ? JSON.stringify(value) : String(value)}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {selectedNode.dependencies && selectedNode.dependencies.length > 0 && (
                                        <div className="detail-section">
                                            <h3>Dependencies ({selectedNode.dependencies.length})</h3>
                                            <div className="dependency-list">
                                                {selectedNode.dependencies.map(dep => (
                                                    <div
                                                        key={dep}
                                                        className="dependency-item"
                                                        onClick={() => highlightNode(dep)}
                                                    >
                                                        {dep}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {selectedNode.dependents && selectedNode.dependents.length > 0 && (
                                        <div className="detail-section">
                                            <h3>Dependents ({selectedNode.dependents.length})</h3>
                                            <div className="dependency-list">
                                                {selectedNode.dependents.map(dep => (
                                                    <div
                                                        key={dep}
                                                        className="dependency-item"
                                                        onClick={() => highlightNode(dep)}
                                                    >
                                                        {dep}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {selectedNode.metrics && (
                                        <div className="detail-section">
                                            <h3>Metrics</h3>
                                            <div className="metadata-item">
                                                <span className="metadata-key">In Degree</span>
                                                <span className="metadata-value">{selectedNode.metrics.in_degree || 0}</span>
                                            </div>
                                            <div className="metadata-item">
                                                <span className="metadata-key">Out Degree</span>
                                                <span className="metadata-value">{selectedNode.metrics.out_degree || 0}</span>
                                            </div>
                                            <div className="metadata-item">
                                                <span className="metadata-key">Impact Score</span>
                                                <span className="metadata-value">{selectedNode.metrics.impact_score || 0}</span>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        <div className="controls">
                            <button className="control-button" onClick={() => runLayout('hierarchical')}>
                                📊 Hierarchical
                            </button>
                            <button className="control-button" onClick={() => runLayout('force')}>
                                🌐 Force
                            </button>
                            <button className="control-button" onClick={() => runLayout('circular')}>
                                ⭕ Circular
                            </button>
                            <button className="control-button" onClick={fitGraph}>
                                📐 Fit
                            </button>
                            <button className="control-button" onClick={resetZoom}>
                                🔍 Reset
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        // Render the app
        ReactDOM.render(<GraphVisualizer />, document.getElementById('root'));
    </script>
</body>
</html>